@using Ctf4e.Server.Models
@using Ctf4e.Server.ViewModels
@model Ctf4e.Server.ViewModels.AdminScoreboard
@{
    var currentUser = (User)ViewData["CurrentUser"];
}

@foreach(var user in Model.UserEntries)
{
    <div class="card mb-1">
    <div class="card-header container" id="user@(user.UserId)-card-heading" style="cursor: pointer" data-bs-toggle="collapse" data-bs-target="#user@(user.UserId)-card">
        <div class="row">
            <div class="col">
                @if(user.HasPassed)
                {
                    <i class="bi bi-check-circle-fill text-success" title="Bestanden"></i>
                }
                else
                {
                    <i class="bi bi-x-circle-fill text-danger" title="Nicht bestanden"></i>
                }
                <span class="ms-2">@user.UserName</span>
            </div>
            <div class="col-auto ms-auto">
                @if(user.Status == ScoreboardGroupStatus.BeforePreStart)
                {
                    <span class="badge bg-info" title="Warten auf Vor-Beginn-Phase">Vor Praktikum-Vor-Beginn</span>
                }
                else if(user.Status == ScoreboardGroupStatus.PreStart)
                {
                    <span class="badge bg-warning" title="Vor-Beginn-Phase aktiv">Vor-Beginn-Phase</span>
                }
                else if(user.Status == ScoreboardGroupStatus.Start)
                {
                    <span class="badge bg-warning" title="Praktikum aktiv">Praktikum aktiv</span>
                }
                else if(user.Status == ScoreboardGroupStatus.End)
                {
                    <span class="badge bg-success" title="Praktikum beendet">Praktikum beendet</span>
                }
                else if(user.Status == ScoreboardGroupStatus.Undefined)
                {
                    <span class="badge bg-danger" title="Keine Praktikumsausführung konfiguriert">Nicht konfiguriert</span>
                }
                <span class="badge bg-primary" title="Pflichtaufgaben">@user.PassedMandatoryExercisesCount / @Model.MandatoryExercisesCount</span>
                <span class="badge bg-secondary" title="Freiwillige Aufgaben">@user.PassedOptionalExercisesCount / @Model.OptionalExercisesCount</span>
                <span class="badge bg-info" title="Gefundene Flags">@user.FoundFlagsCount / @Model.FlagCount</span>
            </div>
        </div>
    </div>
    <div id="user@(user.UserId)-card" class="collapse">
        <div class="card-body">
            <a class="btn btn-primary mb-3" asp-controller="AdminScoreboard" asp-action="CallLabServer" asp-route-labId="@Model.LabId" asp-route-userId="@user.UserId" target="_blank">
                <i class="bi bi-arrow-return-right"></i>
                <i class="bi bi-hdd-network"></i>
                Zum Praktikumsserver (Admin-Modus)
            </a>

            @foreach(var exercise in user.Exercises)
            {
                <div class="card mb-2">
                    <div class="card-header container">
                        <div class="row">
                            <div class="col">
                                @exercise.Exercise.Name
                                @if(exercise.Exercise.IsMandatory)
                                {
                                    <span class="badge bg-info">Pflicht</span>
                                }
                            </div>
                            <div class="col-auto ms-auto">
                                <span class="badge bg-light" title="Gültige Versuche (Versuche insgesamt)">@exercise.ValidTries (@exercise.Tries) Versuche</span>
                                @if(exercise.Passed)
                                {
                                    <span class="badge bg-primary">@exercise.Points Punkte</span>
                                    <i class="bi bi-check-circle-fill text-success" title="Gelöst"></i>
                                }
                                else
                                {
                                    <i class="bi bi-x-circle-fill text-danger" title="Nicht gelöst"></i>
                                }
                            </div>
                        </div>
                    </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                <tr>
                                    <th></th>
                                    <th scope="col">Gelöst</th>
                                    <th scope="col">Zeit</th>
                                    <th scope="col">Gewichtung</th>
                                    @if(Model.PassAsGroup)
                                    {
                                        <th scope="col">Eingereicht von</th>
                                    }
                                    @if(currentUser.IsAdmin)
                                    {
                                        <th>
                                            <a role="button" class="btn btn-sm btn-primary" href="#" data-bs-toggle="modal" data-bs-target="#modal-add-exercise-submission" data-exerciseid="@exercise.Exercise.Id" data-userid="@user.UserId">
                                                <i class="bi bi-plus"></i>
                                                Hinzufügen
                                            </a>
                                        </th>
                                    }
                                </tr>
                                </thead>
                                <tbody>
                                @foreach(var submission in exercise.Submissions)
                                {
                                    <tr>
                                        <th scope="row">#@submission.Id</th>
                                        <td>
                                            @if(submission.ExercisePassed)
                                            {
                                                <i class="bi bi-check-circle-fill text-success align-middle"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-x-circle-fill text-danger align-middle"></i>
                                            }
                                        </td>
                                        <td>
                                            @submission.SubmissionTime.ToString(DateTimeFormats.DateAndTimeSeconds)
                                        </td>
                                        <td>
                                            @submission.Weight
                                        </td>
                                        @if(Model.PassAsGroup)
                                        {
                                            <td>
                                                @Model.UserNames[submission.UserId]
                                            </td>
                                        }
                                        @if(currentUser.IsAdmin)
                                        {
                                            <td>
                                                <a role="button" class="btn btn-sm btn-danger" href="#" data-bs-toggle="modal" data-bs-target="#modal-delete-exercise-submission" data-submissionid="@submission.Id" data-exercisename="@exercise.Exercise.Name" data-username="@user.UserName">
                                                    <i class="bi bi-trash"></i>
                                                    Löschen
                                                </a>
                                            </td>
                                        }
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>
                </div>
            }

            <table class="table table-sm mt-3">
                <thead>
                <tr>
                    <th>Flag</th>
                    <th scope="col">Beschreibung</th>
                    <th scope="col">Abgesendet</th>
                    <th scope="col">Gültig</th>
                    @if(currentUser.IsAdmin)
                    {
                        <th scope="col">Aktionen</th>
                    }
                </tr>
                </thead>
                <tbody>
                @foreach(var flag in user.Flags)
                {
                    <tr>
                        <th scope="row">#@flag.Flag.Id</th>
                        <td>
                            @flag.Flag.Description
                            @if(flag.Flag.IsBounty)
                            {
                                <i class="bi bi-bug-fill text-primary" title="Bug-Bounty"></i>
                            }
                        </td>
                        <td>
                            @if(flag.Submitted)
                            {
                                <i class="bi bi-check-circle-fill text-success" title="@flag.SubmissionTime.ToString(DateTimeFormats.DateAndTimeSeconds)"></i>
                            }
                        </td>
                        <td>
                            @if(flag.Submitted)
                            {
                                if(flag.Valid)
                                {
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    <span class="badge bg-primary">@flag.CurrentPoints Punkte</span>
                                }
                                else
                                {
                                    <i class="bi bi-x-circle-fill text-danger"></i>
                                }
                            }
                        </td>
                        @if(currentUser.IsAdmin)
                        {
                            <td>
                                @if(flag.Submitted)
                                {
                                    <a role="button" class="btn btn-sm btn-danger" href="#" data-bs-toggle="modal" data-bs-target="#modal-delete-flag-submission" data-flagid="@flag.Flag.Id" data-userid="@user.UserId" data-username="@user.UserName">
                                        <i class="bi bi-trash"></i>
                                        Zurücksetzen
                                    </a>
                                }
                                else
                                {
                                    <a role="button" class="btn btn-sm btn-success" href="#" data-bs-toggle="modal" data-bs-target="#modal-add-flag-submission" data-flagid="@flag.Flag.Id" data-userid="@user.UserId">
                                        <i class="bi bi-flag-fill"></i>
                                        Einreichen
                                    </a>
                                }
                            </td>
                        }
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
    </div>
}

<!-- Exercise and Flag submission modals -->
<div class="modal fade" id="modal-delete-exercise-submission" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aufgabeneinreichung löschen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>
                    Wollen Sie die Einreichung von &quot;<span data-replace="user-name"></span>&quot; zur Aufgabe &quot;<span data-replace="exercise-name"></span>&quot; wirklich löschen?
                </p>
            </div>
            <div class="modal-footer">
                <form asp-controller="AdminScoreboard" asp-action="DeleteExerciseSubmission" asp-route-labId="@Model.LabId" asp-route-slotId="@Model.SlotId" method="post">
                    <input type="hidden" data-replace="submission-id" name="submissionId" value="">

                    <button type="submit" class="btn btn-outline-danger">Einreichung löschen</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-add-exercise-submission" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form asp-controller="AdminScoreboard" asp-action="CreateExerciseSubmission" asp-route-labId="@Model.LabId" asp-route-slotId="@Model.SlotId" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Aufgabeneinreichung erstellen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="input-add-exercise-submission-time">Einreichungszeitpunkt</label>
                        <input id="input-add-exercise-submission-time" name="submissionTime" type="text" class="form-control" value="@DateTime.Now.ToString(DateTimeFormats.DateAndTimeMinutes)" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="input-add-exercise-submission-weight">Gewichtung (nur für Fehlversuche)</label>
                        <input id="input-add-exercise-submission-weight" name="weight" type="number" min="0" value="1" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input id="input-add-exercise-submission-passed" type="checkbox" name="passed" class="form-check-input" checked value="true">
                            <label for="input-add-exercise-submission-passed" class="form-check-label">Bestanden</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" data-replace="exercise-id" name="exerciseId" value="">
                    <input type="hidden" data-replace="user-id" name="userId" value="">

                    <button type="submit" class="btn btn-outline-primary">Einreichung erstellen</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-delete-flag-submission" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Flageinreichung löschen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>
                    Wollen Sie die Flag-Einreichung von &quot;<span data-replace="user-name"></span>&quot; wirklich löschen?
                </p>
            </div>
            <div class="modal-footer">
                <form asp-controller="AdminScoreboard" asp-action="DeleteFlagSubmission" asp-route-labId="@Model.LabId" asp-route-slotId="@Model.SlotId" method="post">
                    <input type="hidden" data-replace="user-id" name="userId" value="">
                    <input type="hidden" data-replace="flag-id" name="flagId" value="">

                    <button type="submit" class="btn btn-outline-danger">Einreichung löschen</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-add-flag-submission" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form asp-controller="AdminScoreboard" asp-action="CreateFlagSubmission" asp-route-labId="@Model.LabId" asp-route-slotId="@Model.SlotId" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Flageinreichung erstellen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="input-add-flag-submission-time">Einreichungszeitpunkt</label>
                        <input id="input-add-flag-submission-time" name="submissionTime" type="text" class="form-control" value="@DateTime.Now.ToString(DateTimeFormats.DateAndTimeMinutes)" />
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" data-replace="user-id" name="userId" value="">
                    <input type="hidden" data-replace="flag-id" name="flagId" value="">

                    <button type="submit" class="btn btn-outline-primary">Einreichung erstellen</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Date time picker
flatpickr.localize(flatpickr.l10ns.de);                               
options = {
             "dateFormat": "d.m.Y H:i",
             "enableTime": true,
             "allowInput": true
         };
flatpickr(document.getElementById("input-add-exercise-submission-time"), options);
flatpickr(document.getElementById("input-add-flag-submission-time"), options);

// Modals
document.getElementById("modal-delete-exercise-submission").addEventListener("show.bs.modal", function(e)
{
    e.target.querySelector('input[data-replace="submission-id"]').value = e.relatedTarget.dataset.submissionid;
    e.target.querySelector('span[data-replace="user-name"]').innerText = e.relatedTarget.dataset.username;
    e.target.querySelector('span[data-replace="exercise-name"]').innerText = e.relatedTarget.dataset.exercisename;
});
document.getElementById("modal-add-exercise-submission").addEventListener("show.bs.modal", function(e)
{
    e.target.querySelector('input[data-replace="exercise-id"]').value = e.relatedTarget.dataset.exerciseid;
    e.target.querySelector('input[data-replace="user-id"]').value = e.relatedTarget.dataset.userid;
});
document.getElementById("modal-delete-flag-submission").addEventListener("show.bs.modal", function(e)
{
    e.target.querySelector('input[data-replace="flag-id"]').value = e.relatedTarget.dataset.flagid;
    e.target.querySelector('input[data-replace="user-id"]').value = e.relatedTarget.dataset.userid;
    e.target.querySelector('span[data-replace="user-name"]').innerText = e.relatedTarget.dataset.username;
});
document.getElementById("modal-add-flag-submission").addEventListener("show.bs.modal", function(e)
{
    e.target.querySelector('input[data-replace="flag-id"]').value = e.relatedTarget.dataset.flagid;
    e.target.querySelector('input[data-replace="user-id"]').value = e.relatedTarget.dataset.userid;
});
</script>